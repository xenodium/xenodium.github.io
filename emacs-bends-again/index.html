<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2024-04-05 Fri 04:16 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emacs bends again</title>
<meta name="author" content="Álvaro Ramírez" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<style type='text/css'>
         /* https://stackoverflow.com/questions/6370690/media-queries-how-to-target-desktop-tablet-and-mobile */

         body {
           font-size: 100%;
           max-width: 88ch;
           padding: 2ch;
           margin: auto;
           background-color: white;
         }

         .figure {
           padding: 0;
         }

         /* Table left border */
         .left {
           border-left: 1px solid #ccc;
         }

         .author {
           font-size: 1em;
           text-align: right;
           color: rgb(51, 51, 51);
           font-weight: bold;
           font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
           line-height: 1.15em;
         }

         .title {
           display: none; /* Title already included in header. Hide. */
           color: rgb(51, 51, 51);
           font-size: 1em;
           text-align: right;
         }

         .org-src-container {
           background-color: #fbfbfb;
           border-radius: 10px;
         }

         #contact-header {
           width: 100%;
         }

         #contact-right {
           text-align: right;
         }

         #contact-left {
           text-align: left;
         }

         #content {
         }

         blockquote {
           overflow: auto;
         }

         b, strong {
          font-weight: bold;
         }

         pre {
           border: none;
           box-shadow: none;
         }

         pre.src {
           overflow: auto;
         }

         /* Hide sh/bash/Emacs Lisp overlay */
         pre.src:hover:before {
           display: none;
         }

         p, .org-ol, .org-ul, .org-left {
           color: #3A4145;
           font-family: 'Lucida Grande', 'Lucida Sans Unicode',
               'Lucida Sans', Geneva, Verdana, sans-serif;
           font-size: 1em;
           font-style: normal;
           font-weight: 300;
           letter-spacing: 0.01rem;
           line-height: 1.5em;
           text-rendering: optimizelegibility;
         }

         h1, h2, h3, h4, h5, #preamble {
           color: #2E2E2E;
           font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
           line-height: 1.15em;
         }

         h1 {
           font-size: 2em;
         }

         h2 {
           font-size: 1.6em;
           letter-spacing: -0.02em;
           margin-bottom: 0px;
           text-indent: -3px;
         }

         h3 {
           font-size: 1.2em;
         }

         #preamble {
           text-align: right;
         }

         .timestamp {
          color: #a9a9a9;
          display: block;
          font-family: 'Lucida Grande', 'Lucida Sans Unicode',
              'Lucida Sans', Geneva, Verdana, sans-serif;
          font-size: 0.5em;
          font-style: normal;
          font-weight: 300;
          line-height: 1em;
         }

         .modified-timestamp {
           color: #D3d3d3;
           font-family: 'Lucida Grande', 'Lucida Sans Unicode',
               'Lucida Sans', Geneva, Verdana, sans-serif;
           font-size: 0.8em;
           text-rendering: optimizelegibility;
         }

         a {
          color: #4183C4;
          text-decoration: none;
         }

         a:visited {
          background-color: #4183C4;
         }

         .outline-2 {
         }

         .example {
           white-space: pre-wrap;
           background-color: #f8ffe1;
         }
       </style>

       <!-- Start of Goat Code -->
       <script data-goatcounter="https://xenodium.goatcounter.com/count"
               async src="//gc.zgo.at/count.js">
       </script>
       <!-- End of Goat Code -->
</head>
<body>
<div id="preamble" class="status">

<table id='contact-header'>
  <tr>
    <td id='contact-left'>
      <a style='color:rgb(51, 51, 51);' href='/'>index</a>
      <a style='color:rgb(51, 51, 51);' href='/rss.xml'>rss</a>
    </td>
    <td id='contact-right'>
      <a rel='me' href='https://indieweb.social/@xenodium'>mastodon</a>
      <a href='https://twitter.com/xenodium'>twitter</a>
      <a href='http://github.com/xenodium'>github</a>
      <a href='http://uk.linkedin.com/in/xenodium'>linkedin</a>
      <a href='mailto:me@xenodium.com'>email</a>
    </td>
  </tr>
  <tr>
    <td style='text-align: left;'>
      <a href='https://plainorg.com'>
        <img style='padding-top: 5px; max-width: 4ch;' src='https://plainorg.com/favicon.ico'/>
      </a>
      <a href='https://apps.apple.com/app/id1671420139'>
        <img style='padding-top: 5px; max-width: 4ch;' src='../images/scratch-a-minimal-scratch-area/scratch_icon.png'/>
      </a>
      <a href='https://flathabits.com'>
        <img style='padding-top: 5px; max-width: 4ch;' src='https://flathabits.com/favicon.ico'/>
      </a>
      <a href='https://apps.apple.com/app/id6480411697'>
        <img style='padding-top: 5px; max-width: 4ch;' src='../images/fresh-eyes-now-on-the-app-store/fresh_eyes_icon.png'/>
      </a>
    </td>
    <td style='padding-top:10px;'>
      <span class='author'>Álvaro Ramírez</span><br/>
      <a style='color:rgb(51, 51, 51);' href='https://github.com/sponsors/xenodium'>sponsor</a>
    </td>
  </tr>
</table>
</div>
<div id="content" class="content">
<h1 class="title">Álvaro Ramírez</h1>
<div id="outline-container-emacs-bends-again" class="outline-2">
<h2 id="emacs-bends-again"><span class="timestamp-wrapper"><span class="timestamp">28 November 2021</span></span> Emacs bends again</h2>
<div class="outline-text-2" id="text-emacs-bends-again">
<p>
While adding more rendering capabilities to <a href="https://plainorg.com">Plain Org</a>, it soon became apparent some sort of screenshot/snapshot testing was necessary to prevent regressing existing features. That is, we first generate a rendered snapshot from a given org snippet, followed by some visual inspection, right before we go and save the blessed snapshot (often referred to as golden) to our project. Future changes are validated against the golden snapshot to ensure rendering is still behaving as expected.
</p>

<p>
Let's say we'd like to validate table rendering with links, we can write a test as follows:
</p>

<div class="org-src-container">
<pre class="src src-swift"><span style="color: #a71d5d;">func</span> <span style="color: #795da3;">testTableWithLinks</span>() <span style="color: #a71d5d;">throws</span> {
  <span style="color: #795da3;">assertSnapshot</span>(
    matching: OrgMarkupText.<span style="color: #795da3;">make</span>(
      <span style="color: #183691;">"""</span>
<span style="color: #183691;">      | URL                    | Org link    |</span>
<span style="color: #183691;">      |------------------------+-------------|</span>
<span style="color: #183691;">      | https://flathabits.com | [[https://flathabits.com][Flat Habits]] |</span>
<span style="color: #183691;">      | Regular text           | Here too    |</span>
<span style="color: #183691;">      |------------------------+-------------|</span>
<span style="color: #183691;">      """</span>),
    <span style="color: #a71d5d;">as</span>: .<span style="color: #a71d5d;">image</span>(layout: .<span style="color: #333333;">sizeThatFits</span>))
}
</pre>
</div>

<p>
The corresponding snapshot golden can be seen below.
</p>


<div id="org2330167" class="figure">
<p><img src="../images/emacs-bends-again/testTableWithLinks.1.png" alt="testTableWithLinks.1.png" width="50%" />
</p>
</div>

<p>
This is all done rather effortlessly thanks to <a href="https://twitter.com/pointfreeco">Point Free</a>'s wonderful <a href="https://github.com/pointfreeco/swift-snapshot-testing">swift-snapshot-testing</a> utilities.
</p>

<p>
So what does any of this have to do with Emacs? You see, as I added more snapshot tests and made modifications to the rendering logic, I needed a quick way to visually inspect and override all goldens. All the main pieces were already there, I just needed some elisp glue to <i>bend Emacs my way™.</i>
</p>

<p>
First, I needed to run my Xcode builds from the command line. This is already <a href="https://developer.apple.com/library/archive/technotes/tn2339/_index.html">supported via xcodebuild</a>. Next, I needed a way to parse test execution data to extract failing tests. <a href="https://twitter.com/davidahouse">David House</a>'s <a href="https://github.com/davidahouse/xcodebuild-to-json">xcodebuild-to-json</a> handles this perfectly. What's left? Glue it all up with some elisp.
</p>

<p>
Beware, the following code snippet is packed with assumptions about my project, it's messy, surely has bugs, can be optimized, etc. But the important point here is that Emacs is such an amazing malleable power tool. Throw some elisp at it and you can to bend it to your liking. After all, it's <span class="underline">your</span> editor.
</p>

<p>
And so here we are, I can now run snapshot tests from Emacs using my hacked up <code>plainorg-snapshot-test-all</code> function and quickly override (or ignore) all newly generated snapshots by merely pressing y/n keys. Oh, and our beloved web browser was also invited to the party. Press "d" to open two browser tabs if you'd like to take a closer look (not demoed below).
</p>

<p>
Success. <i>Emacs bends again</i>.
</p>


<div id="org497e831" class="figure">
<p><img src="../images/emacs-bends-again/diff.gif" alt="diff.gif" width="95%" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-emacs-lisp"><span style="color: #969896;">;;; </span><span style="color: #969896;">-*- lexical-binding: t; -*-</span>

(<span style="color: #a71d5d;">defun</span> <span style="color: #795da3;">plainorg-snapshot-test-all</span> ()
  <span style="color: #183691;">"Invoke xcodebuild, compare failed tests screenshots side-to-side,</span>
<span style="color: #183691;">and offer to override them."</span>
  (<span style="color: #a71d5d;">interactive</span>)
  (<span style="color: #a71d5d;">let*</span> ((project (cdr (project-current)))
         (json-tmp-file (make-temp-file <span style="color: #183691;">"PlainOrg_Tests_"</span> nil <span style="color: #183691;">".json"</span>))
         (default-directory project))
    (<span style="color: #a71d5d;">unless</span> (file-exists-p (concat project <span style="color: #183691;">"PlainOrg.xcodeproj"</span>))
      (<span style="color: #333333;">user-error</span> <span style="color: #183691;">"Not in PlainOrg project"</span>))
    (set-process-sentinel
     (start-process
      <span style="color: #183691;">"xcodebuild"</span>
      (<span style="color: #a71d5d;">with-current-buffer</span>
          (get-buffer-create <span style="color: #183691;">"*xcodebuild*"</span>)
        (<span style="color: #a71d5d;">let</span> ((inhibit-read-only t))
          (erase-buffer))
        (current-buffer))
      <span style="color: #183691;">"/usr/bin/xcodebuild"</span>
      <span style="color: #183691;">"-scheme"</span> <span style="color: #183691;">"PlainOrg"</span> <span style="color: #183691;">"-target"</span> <span style="color: #183691;">"PlainOrgTests"</span> <span style="color: #183691;">"-destination"</span> <span style="color: #183691;">"name=iPhone 13"</span> <span style="color: #183691;">"-quiet"</span> <span style="color: #183691;">"test"</span>)
     (<span style="color: #a71d5d;">lambda</span> (p e)
       (<span style="color: #a71d5d;">with-current-buffer</span> (get-buffer <span style="color: #183691;">"*xcodebuild*"</span>)
         (<span style="color: #a71d5d;">let</span> ((inhibit-read-only t))
           (insert (format <span style="color: #183691;">"xcodebuild exit code: %d\n\n"</span> (process-exit-status p)))))
       (<span style="color: #a71d5d;">when</span> (not (eq 0 (process-exit-status p)))
         (set-process-sentinel
          (start-process
           <span style="color: #183691;">"xcodebuild-to-json"</span>
           <span style="color: #183691;">"*xcodebuild*"</span>
           <span style="color: #183691;">"/opt/homebrew/bin/xcodebuild-to-json"</span>
           <span style="color: #183691;">"--derived-data-folder"</span> (format <span style="color: #183691;">"/Users/%s/Library/Developer/Xcode/DerivedData/"</span>
                                           (user-login-name)) <span style="color: #333333;">"--output"</span><span style="color: #333333;"> json-tmp-file)</span>
          (<span style="color: #a71d5d;">lambda</span> (p e)
            (<span style="color: #a71d5d;">with-current-buffer</span> (get-buffer <span style="color: #183691;">"*xcodebuild*"</span>)
              (<span style="color: #a71d5d;">let</span> ((inhibit-read-only t))
                (insert (format <span style="color: #183691;">"xcodebuild-to-json exit code: %d\n\n"</span> (process-exit-status p)))))
            (<span style="color: #a71d5d;">when</span> (= 0 (process-exit-status p))
              (<span style="color: #a71d5d;">with-current-buffer</span> (get-buffer <span style="color: #183691;">"*xcodebuild*"</span>)
                (<span style="color: #a71d5d;">let</span> ((inhibit-read-only t))
                  (insert <span style="color: #183691;">"Screenshot comparison started\n\n"</span>)))
              (plainorg--snapshot-process-json (get-buffer <span style="color: #183691;">"*xcodebuild*"</span>) json-tmp-file)
              (<span style="color: #a71d5d;">with-current-buffer</span> (get-buffer <span style="color: #183691;">"*xcodebuild*"</span>)
                (<span style="color: #a71d5d;">let</span> ((inhibit-read-only t))
                  (insert <span style="color: #183691;">"\nScreenshot comparison finished\n"</span>))
                (read-only-mode +1))))))))
    (switch-to-buffer-other-window <span style="color: #183691;">"*xcodebuild*"</span>)))

(<span style="color: #a71d5d;">defun</span> <span style="color: #795da3;">plainorg--snapshot-process-json</span> (result-buffer json)
  <span style="color: #183691;">"Find all failed snapshot tests in JSON and offer to override</span>
<span style="color: #183691;"> screenshots, comparing them side to side."</span>
  (<span style="color: #a71d5d;">let</span> ((hashtable (<span style="color: #a71d5d;">with-current-buffer</span> (get-buffer-create <span style="color: #183691;">"*build json*"</span>)
                     (erase-buffer)
                     (insert-file-contents json)
                     (json-parse-buffer))))
    (mapc
     (<span style="color: #a71d5d;">lambda</span> (item)
       (<span style="color: #a71d5d;">when</span> (equal (gethash <span style="color: #183691;">"id"</span> item)
                    <span style="color: #183691;">"SnapshotTests"</span>)
         (mapc
          (<span style="color: #a71d5d;">lambda</span> (testCase)
            (<span style="color: #a71d5d;">when</span> (<span style="color: #a71d5d;">and</span> (gethash <span style="color: #183691;">"failureMessage"</span> testCase)
                       (string-match-p <span style="color: #183691;">"Snapshot does not match reference"</span>
                                       (gethash <span style="color: #183691;">"failureMessage"</span> testCase)))
              (<span style="color: #a71d5d;">let*</span> ((paths (plainorg--snapshot-screenshot-paths
                             (gethash <span style="color: #183691;">"failureMessage"</span> testCase)))
                     (override-result (plainorg--snapshot-override-image
                                       <span style="color: #183691;">"Expected screenshot"</span>
                                       (nth 0 paths) <span style="color: #969896;">;; </span><span style="color: #969896;">old</span>
                                       <span style="color: #183691;">"Actual screenshot"</span>
                                       (nth 1 paths) <span style="color: #969896;">;; </span><span style="color: #969896;">new</span>
                                       (nth 0 paths))))
                (<span style="color: #a71d5d;">when</span> override-result
                  (<span style="color: #a71d5d;">with-current-buffer</span> result-buffer
                    (<span style="color: #a71d5d;">let</span> ((inhibit-read-only t))
                      (insert override-result)
                      (insert <span style="color: #183691;">"\n"</span>)))))))
          (gethash <span style="color: #183691;">"testCases"</span> item))))
     (gethash <span style="color: #183691;">"classes"</span> (gethash <span style="color: #183691;">"details"</span> hashtable)))))

(<span style="color: #a71d5d;">defun</span> <span style="color: #795da3;">plainorg--snapshot-screenshot-paths</span> (failure-message)
  <span style="color: #183691;">"Extract a paths list from FAILURE-MESSAGE of the form:</span>

<span style="color: #183691;">failed - Snapshot does not match reference.</span>

<span style="color: #183691;">@&#8722;</span>
<span style="color: #183691;">\"/path/to/expected/screenshot.1.png\"</span>
<span style="color: #183691;">@+</span>
<span style="color: #183691;">\"/path/to/actual/screenshot.1.png\"</span>

<span style="color: #183691;">Newly-taken snapshot does not match reference.</span>
<span style="color: #183691;">"</span>
  (mapcar
   (<span style="color: #a71d5d;">lambda</span> (line)
     (string-remove-suffix <span style="color: #183691;">"\""</span>
                           (string-remove-prefix <span style="color: #183691;">"\""</span> line)))
   (seq-filter
    (<span style="color: #a71d5d;">lambda</span> (line)
      (string-prefix-p <span style="color: #183691;">"\""</span> line))
    (split-string failure-message <span style="color: #183691;">"\n"</span>))))

(<span style="color: #a71d5d;">defun</span> <span style="color: #795da3;">plainorg--snapshot-override-image</span> (old-buffer old new-buffer new destination)
  (<span style="color: #a71d5d;">let</span> ((window-configuration (current-window-configuration))
        (action)
        (result))
    (<span style="color: #a71d5d;">unwind-protect</span>
        (<span style="color: #a71d5d;">progn</span>
          (delete-other-windows)
          (split-window-horizontally)
          (switch-to-buffer (<span style="color: #a71d5d;">with-current-buffer</span> (get-buffer-create old-buffer)
                              (<span style="color: #a71d5d;">let</span> ((inhibit-read-only t))
                                (erase-buffer))
                              (insert-file-contents old)
                              (image-mode)
                              (current-buffer)))
          (switch-to-buffer-other-window (<span style="color: #a71d5d;">with-current-buffer</span> (get-buffer-create new-buffer)
                                           (<span style="color: #a71d5d;">let</span> ((inhibit-read-only t))
                                             (erase-buffer))
                                           (insert-file-contents new)
                                           (image-mode)
                                           (current-buffer)))
          (<span style="color: #a71d5d;">while</span> (null result)
            (<span style="color: #a71d5d;">setq</span> action (read-char-choice (format <span style="color: #183691;">"Override %s? (y)es (n)o (d)iff in browser? "</span>
                                                   (file-name-base old))
                                           '(?y ?n ?d ?q)))
            (<span style="color: #a71d5d;">cond</span> ((eq action ?n)
                   (<span style="color: #a71d5d;">setq</span> result
                         (format <span style="color: #183691;">"Keeping old %s"</span> (file-name-base old))))
                  ((eq action ?y)
                   (copy-file new old t)
                   (<span style="color: #a71d5d;">setq</span> result
                         (format <span style="color: #183691;">"Overriding old %s"</span> (file-name-base old))))
                  ((eq action ?d)
                   (shell-command (format <span style="color: #183691;">"open -a Firefox %s --args --new-tab"</span> old))
                   (shell-command (format <span style="color: #183691;">"open -a Firefox %s --args --new-tab"</span> new)))
                  ((eq action ?q)
                   (set-window-configuration window-configuration)
                   (<span style="color: #a71d5d;">setq</span> result (format <span style="color: #183691;">"Quit %s"</span> (file-name-base old)))))))
      (set-window-configuration window-configuration)
      (kill-buffer old-buffer)
      (kill-buffer new-buffer))
    result))
</pre>
</div>
</div>
</div>
</div>
</body>
</html>
